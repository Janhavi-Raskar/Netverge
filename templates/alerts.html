<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Alerts - Netverge NIDS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
            color: #e0e0e0;
            font-family: 'Roboto Mono', monospace;
        }
        .cyber-title {
            font-family: 'Orbitron', 'Roboto Mono', monospace;
            font-size: 2.2rem;
            color: #00fff7;
            text-shadow: 0 0 10px #00fff7, 0 0 20px #0ff, 0 0 40px #0ff;
            letter-spacing: 2px;
            margin-bottom: 0.5em;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px #00fff7, 0 0 20px #0ff, 0 0 40px #0ff; }
            to { text-shadow: 0 0 20px #00fff7, 0 0 40px #0ff, 0 0 80px #0ff; }
        }
        .cyber-btn {
            font-family: 'Orbitron', 'Roboto Mono', monospace;
            font-size: 1.1rem;
            margin: 0 0.5em;
            padding: 0.75em 2em;
            border-radius: 30px;
            border: none;
            background: linear-gradient(90deg, #00fff7 0%, #007cf0 100%);
            color: #111;
            box-shadow: 0 0 10px #00fff7, 0 0 20px #007cf0;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }
        .cyber-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 20px #00fff7, 0 0 40px #007cf0;
            color: #fff;
            text-decoration: none;
        }
        .cyber-table {
            background: rgba(60, 80, 110, 0.85);
            border-radius: 18px;
            box-shadow: 0 0 30px #00fff7a0;
            padding: 2em 1em 1em 1em;
        }
        .table-dark th, .table-dark td {
            color: #b0eaff;
        }
        .alert-warning {
            background: #fff3cd;
            color: #222c36;
            border: 1px solid #00fff7;
        }
        .cyber-navbar {
            background: rgba(20, 40, 60, 0.92) !important;
            box-shadow: 0 2px 16px #00fff7a0;
            border-bottom: 1.5px solid #007cf0;
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark cyber-navbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Netverge NIDS</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/upload">Upload</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/alerts">Alerts</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
    <div class="container py-5">
        <h2 class="cyber-title mb-4">All Alerts</h2>
        <!-- Chart Section -->
        <div class="row mb-5">
            <div class="col-md-6 mb-4">
                <div class="card p-3 cyber-table">
                    <h5 class="text-center mb-3" style="color:#00fff7;">Alerts per Priority</h5>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card p-3 cyber-table">
                    <h5 class="text-center mb-3" style="color:#00fff7;">Alert Types Frequency</h5>
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>
        <!-- End Chart Section -->
        <!-- Search and Filter Section -->
        <div class="row mb-4 align-items-end">
            <div class="col-md-3 mb-2">
                <input id="alertSearch" type="text" class="form-control" placeholder="Search alerts (type, IP, etc.)">
            </div>
            <div class="col-md-2 mb-2">
                <select id="priorityFilter" class="form-select">
                    <option value="">All Priorities</option>
                    <option value="1">Priority 1</option>
                    <option value="2">Priority 2</option>
                    <option value="3">Priority 3</option>
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <input id="dateFrom" type="datetime-local" class="form-control" placeholder="From">
            </div>
            <div class="col-md-2 mb-2">
                <input id="dateTo" type="datetime-local" class="form-control" placeholder="To">
            </div>
            <div class="col-md-3 mb-2 d-flex gap-2 justify-content-end">
                <button class="cyber-btn" onclick="window.location.reload()">Refresh</button>
                <button class="cyber-btn" id="exportCsvBtn">Export to CSV</button>
            </div>
        </div>
        {% if alerts %}
        <div class="table-responsive cyber-table">
            <table id="alertsTable" class="table table-dark table-striped table-bordered align-middle" style="cursor:pointer;">
                <thead>
                    <tr>
                        <th>Alert Message</th>
                        <th>Priority</th>
                        <th>Timestamp</th>
                        <th>Source IP</th>
                        <th>Destination IP</th>
                        <th>Suspicion Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in alerts %}
                    <tr data-alert='{{ alert | tojson | safe }}'>
                        <td>{{ alert.alert_message }}</td>
                        <td>{{ alert.priority }}</td>
                        <td>{{ alert.timestamp }}</td>
                        <td>{{ alert.src_ip }}</td>
                        <td>{{ alert.dst_ip }}</td>
                        <td>{{ alert.suspicion_score }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">No alerts found in the database.</div>
        {% endif %}
        <div class="d-flex justify-content-center mt-4 mb-4">
            <a href="/upload" class="cyber-btn">Back to Upload</a>
        </div>

        <!-- Alert Details Modal -->
        <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
              <div class="modal-header">
                <h5 class="modal-title" id="alertModalLabel">Alert Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="alertModalBody">
              </div>
            </div>
          </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Data injected from Flask
        const priorityData = {{ priority_data|tojson }};
        const typeData = {{ type_data|tojson }};

        // Pie Chart: Alerts per Priority
        const ctxPriority = document.getElementById('priorityChart').getContext('2d');
        new Chart(ctxPriority, {
            type: 'pie',
            data: {
                labels: priorityData.labels,
                datasets: [{
                    data: priorityData.counts,
                    backgroundColor: ['#00fff7', '#007cf0', '#b0eaff', '#ff6384', '#36a2eb'],
                }]
            },
            options: {
                plugins: { legend: { labels: { color: '#b0eaff', font: { family: 'Orbitron' } } } }
            }
        });

        // Bar Chart: Alert Types Frequency
        const ctxType = document.getElementById('typeChart').getContext('2d');
        new Chart(ctxType, {
            type: 'bar',
            data: {
                labels: typeData.labels,
                datasets: [{
                    label: 'Count',
                    data: typeData.counts,
                    backgroundColor: '#00fff7',
                    borderColor: '#007cf0',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: {
                            color: '#b0eaff',
                            font: { family: 'Orbitron' },
                            maxRotation: 30,
                            minRotation: 30,
                            callback: function(value, index, values) {
                                let label = this.getLabelForValue(value);
                                return label.length > 20 ? label.slice(0, 20) + 'â€¦' : label;
                            }
                        }
                    },
                    y: { ticks: { color: '#b0eaff', font: { family: 'Orbitron' } }, beginAtZero: true }
                }
            }
        });

        // Search, Filter, and Date Range Functionality
        const searchInput = document.getElementById('alertSearch');
        const prioritySelect = document.getElementById('priorityFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const table = document.getElementById('alertsTable');
        prioritySelect.addEventListener('change', filterTable);
        dateFrom.addEventListener('change', filterTable);
        dateTo.addEventListener('change', filterTable);
        searchInput.addEventListener('input', filterTable);

        function filterTable() {
            const search = searchInput.value.toLowerCase();
            const priority = prioritySelect.value;
            const from = dateFrom.value ? new Date(dateFrom.value) : null;
            const to = dateTo.value ? new Date(dateTo.value) : null;
            for (let row of table.tBodies[0].rows) {
                const cells = Array.from(row.cells).map(cell => cell.textContent.toLowerCase());
                const matchesSearch = cells.some(text => text.includes(search));
                const matchesPriority = !priority || row.cells[1].textContent === priority;
                let matchesDate = true;
                if (from || to) {
                    // Parse timestamp: MM/DD-HH:MM:SS.micro
                    const ts = row.cells[2].textContent;
                    let dateObj = null;
                    try {
                        const [md, hms] = ts.split('-');
                        const [month, day] = md.split('/');
                        const [hour, minute, rest] = hms.split(':');
                        const [second, micro] = rest.split('.');
                        dateObj = new Date();
                        dateObj.setMonth(parseInt(month)-1);
                        dateObj.setDate(parseInt(day));
                        dateObj.setHours(parseInt(hour));
                        dateObj.setMinutes(parseInt(minute));
                        dateObj.setSeconds(parseInt(second));
                        dateObj.setMilliseconds(parseInt(micro.slice(0,3)));
                    } catch {}
                    if (from && dateObj && dateObj < from) matchesDate = false;
                    if (to && dateObj && dateObj > to) matchesDate = false;
                }
                row.style.display = (matchesSearch && matchesPriority && matchesDate) ? '' : 'none';
            }
        }

        // Export to CSV
        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            let csv = '';
            const rows = table.querySelectorAll('thead tr, tbody tr');
            for (let row of rows) {
                if (row.parentElement.tagName === 'TBODY' && row.style.display === 'none') continue;
                let cells = Array.from(row.children).map(cell => '"' + cell.textContent.replace(/"/g, '""') + '"');
                csv += cells.join(',') + '\n';
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'alerts.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Alert Details Modal
        const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
        const alertModalBody = document.getElementById('alertModalBody');
        table.addEventListener('click', function(e) {
            let tr = e.target.closest('tr');
            if (!tr || !tr.dataset.alert) return;
            const alert = JSON.parse(tr.dataset.alert);
            let html = '<ul class="list-group">';
            for (const [key, value] of Object.entries(alert)) {
                html += `<li class="list-group-item bg-dark text-light"><strong>${key}:</strong> ${value}</li>`;
            }
            html += '</ul>';
            alertModalBody.innerHTML = html;
            alertModal.show();
        });
    </script>
</body>
</html> 